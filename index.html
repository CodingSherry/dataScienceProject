<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Global Flight Network 3D (HD)</title>
    <style>
        body { background: #050505; margin: 0; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #info { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            color: #ccc; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            pointer-events: none; 
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        h1 { margin: 0; font-size: 1.2rem; color: #fff; letter-spacing: 1px;}
        p { margin: 5px 0 0 0; font-size: 0.8rem; opacity: 0.8; }
    </style>
</head>
<body>
    <div id="info"><h1>Global Flights 3D</h1><p>Loading High-Res Data...</p></div>
    <canvas id="globe"></canvas>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>

    <script>
        const canvas = document.getElementById("globe");
        const context = canvas.getContext("2d");

        // --- 核心优化：适配 Mac Retina 高清屏 ---
        function resize() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const dpr = window.devicePixelRatio || 1; // 获取屏幕像素比
            
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + "px";
            canvas.style.height = height + "px";
            
            context.scale(dpr, dpr); // 缩放绘图上下文，保证清晰度
            return { width, height };
        }
        
        let { width, height } = resize();

        // --- 视觉优化：地球放大，配色调整 ---
        const projection = d3.geoOrthographic()
            .scale(height / 1.8) // 放大地球 (之前是 2.5)
            .translate([width / 2, height / 2]);
            
        const path = d3.geoPath(projection, context);

        // 加载地图数据
        d3.json("https://unpkg.com/world-atlas@1/world/110m.json").then(function(world) {
            const land = topojson.feature(world, world.objects.countries);
            
            // 加载您的航班数据
            d3.json("data.json").then(function(data) {
                document.querySelector("#info p").innerText = `Rendering ${data.routes.length} routes | Auto-rotating`;
                
                const airportMap = new Map(data.airports.map(d => [d.code, d.loc]));
                const routes = data.routes.map(r => ({
                    type: "LineString", 
                    coordinates: [airportMap.get(r.source), airportMap.get(r.target)]
                })).filter(d => d.coordinates[0] && d.coordinates[1]);

                // 旋转动画
                d3.timer((elapsed) => {
                    // 稍微转慢一点，方便看细节
                    projection.rotate([elapsed * 0.015, -10]); 
                    
                    context.clearRect(0, 0, width, height);
                    
                    // 1. 画海洋（背景球体）
                    context.beginPath(); 
                    path({type: "Sphere"}); 
                    context.fillStyle = "#1a1a1a"; // 深灰海洋
                    context.fill();
                    
                    // 2. 画陆地
                    context.beginPath(); 
                    path(land); 
                    context.fillStyle = "#2a2a2a"; // 稍亮的陆地
                    context.fill(); 
                    context.lineWidth = 0.5;
                    context.strokeStyle = "#000"; // 国界线
                    context.stroke();
                    
                    // 3. 画航线（极细 + 高透明度 = 精致感）
                    if (routes.length > 0) {
                        context.beginPath(); 
                        routes.forEach(d => path(d)); 
                        // 颜色改为青色 (Cyan)，透明度极低 (0.1) 避免密集处糊成一团
                        context.strokeStyle = "rgba(80, 255, 255, 0.12)"; 
                        context.lineWidth = 0.3; // 极细线条
                        context.stroke();
                    }
                    
                    // 4. 地球外发光圈（装饰）
                    context.beginPath(); 
                    path({type: "Sphere"}); 
                    context.strokeStyle = "rgba(255, 255, 255, 0.1)"; 
                    context.lineWidth = 1; 
                    context.stroke();
                });
            });
        });

        // 窗口大小改变时自动重绘
        window.addEventListener('resize', () => {
             const dim = resize();
             width = dim.width;
             height = dim.height;
             projection.translate([width / 2, height / 2]).scale(height / 1.8);
        });
    </script>
</body>
</html>