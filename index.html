<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Global Flight Network 3D</title>
    <style>
        /* 这里是网页的样式设置 */
        body { 
            background: #050505; /* 深黑背景 */
            color: #fff; 
            margin: 0; 
            overflow: hidden; /* 防止出现滚动条 */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        canvas { 
            display: block; 
            cursor: move; /* 鼠标放上去变成移动手势 */
        }
        #info { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            pointer-events: none; /* 防止文字挡住鼠标操作 */
            z-index: 10;
        }
        h1 { 
            margin: 0; 
            font-size: 28px; 
            background: linear-gradient(to right, #4dc0ff, #bd34fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; /* 炫酷的渐变色标题 */
        }
        p { 
            color: #aaa; 
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>Global 3D Flight Network</h1>
        <p>Python Analysis + D3.js Visualization</p>
        <p style="font-size: 12px; color: #666;">Data Source: OpenFlights.org</p>
    </div>
    
    <!-- 这是画图的画布 -->
    <canvas id="globe"></canvas>

    <!-- 引入 D3.js 核心库 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- 引入地图数据处理库 -->
    <script src="https://unpkg.com/topojson@3"></script>

    <script>
        // === 1. 初始化画布 ===
        const canvas = document.getElementById("globe");
        const context = canvas.getContext("2d");
        
        let width = window.innerWidth;
        let height = window.innerHeight;
        
        // 确保画布填满屏幕
        canvas.width = width;
        canvas.height = height;

        // 设置投影 (Orthographic = 像地球仪一样的3D球体)
        const projection = d3.geoOrthographic()
            .scale(height / 2.2) // 地球大小
            .translate([width / 2, height / 2]); // 居中

        const path = d3.geoPath(projection, context);

        // 变量准备
        let airports = [];
        let routes = [];
        let land = null;
        let rotationSpeed = 0.02; // 旋转速度

        // === 2. 加载数据 ===
        // 先加载世界地图轮廓
        d3.json("https://unpkg.com/world-atlas@1/world/110m.json").then(function(world) {
            land = topojson.feature(world, world.objects.countries);
            
            // 再加载我们在 Python 里生成的 data.json
            d3.json("data.json").then(function(data) {
                
                // 预处理：建立一个查找表，把航线的 IATA 代码变成经纬度坐标
                // 这样画线的时候才知道从哪画到哪
                const airportMap = new Map(data.airports.map(d => [d.code, d.loc]));
                
                routes = data.routes.map(function(r) {
                    // 构建 GeoJSON 格式的线段
                    let sourceLoc = airportMap.get(r.source);
                    let targetLoc = airportMap.get(r.target);
                    
                    if (sourceLoc && targetLoc) {
                        return {
                            type: "LineString",
                            coordinates: [sourceLoc, targetLoc]
                        };
                    }
                    return null;
                }).filter(d => d !== null); // 过滤掉无效数据

                airports = data.airports;
                
                // 数据加载完后，开始启动动画
                d3.timer(function(elapsed) {
                    // 每一帧都让地球转一点点
                    const rotate = projection.rotate();
                    projection.rotate([rotate[0] + rotationSpeed, rotate[1]]);
                    render();
                });
            });
        });

        // === 3. 渲染函数 (负责画画) ===
        function render() {
            context.clearRect(0, 0, width, height);

            // A. 画地球背景 (深色海洋)
            context.beginPath();
            path({type: "Sphere"});
            context.fillStyle = "#111"; // 海洋颜色
            context.fill();

            // B. 画陆地
            if (land) {
                context.beginPath();
                path(land);
                context.fillStyle = "#2a2a2a"; // 陆地颜色
                context.fill();
                context.strokeStyle = "#000"; // 国界线颜色
                context.lineWidth = 0.5;
                context.stroke();
            }

            // C. 画航线 (最炫酷的部分)
            if (routes.length > 0) {
                context.beginPath();
                routes.forEach(d => {
                    path(d);
                });
                // 航线颜色：青色，带透明度
                context.strokeStyle = "rgba(0, 255, 255, 0.15)"; 
                context.lineWidth = 0.8; 
                context.stroke();
            }

            // D. 画地球外框光晕
            context.beginPath();
            path({type: "Sphere"});
            context.strokeStyle = "#333";
            context.lineWidth = 1;
            context.stroke();
        }

        // 窗口大小改变时自动调整
        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            projection.scale(height / 2.2).translate([width / 2, height / 2]);
            render();
        });

    </script>
</body>
</html>