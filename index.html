
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Global Flight Analysis</title>
    <style>
        /* === ‰Ω†ÁöÑÂéüÂßãÊ†∑Âºè (‰øùÊåÅ‰∏çÂèò) === */
        body { background: #080808; margin: 0; overflow: hidden; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        canvas { display: block; }
        #ui-layer {
            position: absolute; top: 30px; left: 30px; pointer-events: none;
            background: rgba(0, 0, 0, 0.7); padding: 20px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px);
            z-index: 10; /* Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç */
        }
        h1 { margin: 0 0 10px 0; font-size: 18px; color: #fff; text-transform: uppercase; letter-spacing: 2px; }
        .metric { display: flex; align-items: center; margin-bottom: 8px; font-size: 12px; color: #ccc; }
        .color-box { width: 12px; height: 12px; margin-right: 10px; border-radius: 2px; }
        .legend-gradient {
            width: 100%; height: 8px; margin: 5px 0;
            background: linear-gradient(to right, #4facfe, #00f2fe, #f093fb, #f5576c);
            border-radius: 4px;
        }
        .legend-labels { display: flex; justify-content: space-between; font-size: 10px; color: #888; }

        /* === Êñ∞Â¢ûÔºöÂΩïÂà∂ÊéßÂà∂Èù¢ÊùøÊ†∑Âºè === */
        #record-ui {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 20; display: flex; gap: 10px;
            background: rgba(20, 20, 20, 0.8); padding: 10px 20px; border-radius: 50px;
            border: 1px solid #444; backdrop-filter: blur(5px);
        }
        .btn {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 8px 16px; border-radius: 20px; cursor: pointer;
            font-size: 13px; font-weight: 600; transition: 0.2s;
        }
        .btn:hover { background: #555; transform: scale(1.05); }
        .btn-start { background: #bd34fe; border-color: #bd34fe; }
        .btn-stop { background: #ff4757; border-color: #ff4757; display: none; }
        #status { color: #aaa; font-size: 12px; line-height: 34px; margin-left: 5px; }
    </style>
</head>
<body>
    <!-- ‰Ω†ÁöÑÂéüÂßã UI Â±Ç -->
    <div id="ui-layer">
        <h1>Flight Network Analysis</h1>

        <div style="margin-top: 15px; margin-bottom: 5px; font-size: 11px; color: #aaa; text-transform: uppercase;">Node Size (Degree Centrality)</div>
        <div class="metric"><div class="color-box" style="background: rgba(255, 50, 50, 0.9); border-radius: 50%;"></div>Major Hubs (>50 Routes)</div>
        <div class="metric"><div class="color-box" style="background: rgba(0, 255, 255, 0.6); border-radius: 50%;"></div>Regional Airports</div>

        <div style="margin-top: 15px; margin-bottom: 5px; font-size: 11px; color: #aaa; text-transform: uppercase;">Flight Distance (Color Scale)</div>
        <div class="legend-gradient"></div>
        <div class="legend-labels">
            <span>Short (< 2k km)</span>
            <span>Long (> 10k km)</span>
        </div>
    </div>

    <!-- Êñ∞Â¢ûÔºöÂΩïÂà∂ÊåâÈíÆ -->
    <div id="record-ui">
        <button id="btnStart" class="btn btn-start">üé• Start Render</button>
        <button id="btnStop" class="btn btn-stop">‚èπ Stop & Save</button>
        <span id="status">Ready</span>
    </div>

    <canvas id="globe"></canvas>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <!-- Êñ∞Â¢ûÔºöCCapture Â∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/ccapture.js-npmfixed@1.1.0/build/CCapture.all.min.js"></script>

    <script>
        const canvas = document.getElementById("globe");
        const context = canvas.getContext("2d");

        // === CCapture ÂàùÂßãÂåñ ===
        // Âº∫Âà∂ 60FPSÔºåËæìÂá∫ WebM ËßÜÈ¢ë
        let capturer = new CCapture({
            format: 'webm',
            framerate: 60,
            quality: 100,
            name: "flight_analysis_video"
        });
        let isRecording = false;
        // ======================

        function resize() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const dpr = window.devicePixelRatio || 1;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + "px";
            canvas.style.height = height + "px";
            context.scale(dpr, dpr);
            return { width, height };
        }
        let { width, height } = resize();

        const projection = d3.geoOrthographic()
            .scale(height / 1.9)
            .translate([width / 2, height / 2]);
        const path = d3.geoPath(projection, context);

        // üåü 1. ÂÆö‰πâÈ¢úËâ≤ÊØî‰æãÂ∞∫ (‰øùÊåÅ‰∏çÂèò)
        const colorScale = d3.scaleSequential(d3.interpolateCool)
            .domain([0, 12000]);

        Promise.all([
            d3.json("https://unpkg.com/world-atlas@1/world/110m.json"),
            d3.json("data.json")
        ]).then(([world, data]) => {
            const land = topojson.feature(world, world.objects.countries);
            const airportMap = new Map(data.airports.map(d => [d.code, d]));

            // üåü 2. È¢ÑÂ§ÑÁêÜ (‰øùÊåÅ‰∏çÂèò)
            const airportCounts = {};

            const routes = data.routes.map(r => {
                const src = airportMap.get(r.source);
                const tgt = airportMap.get(r.target);
                if (!src || !tgt) return null;

                airportCounts[r.source] = (airportCounts[r.source] || 0) + 1;
                airportCounts[r.target] = (airportCounts[r.target] || 0) + 1;

                const distance = d3.geoDistance(src.loc, tgt.loc) * 6371;

                return {
                    type: "LineString",
                    coordinates: [src.loc, tgt.loc],
                    distance: distance
                };
            }).filter(d => d);

            data.airports.forEach(d => d.degree = airportCounts[d.code] || 0);
            data.airports.sort((a, b) => a.degree - b.degree);

            const rScale = d3.scaleSqrt().domain([0, d3.max(Object.values(airportCounts))]).range([1, 6]);

            d3.timer((elapsed) => {
                projection.rotate([elapsed * 0.005, -10]);

                // [‰øÆÊîπÁÇπ 1] ÊòæÂºèÂ°´ÂÖÖËÉåÊôØËâ≤
                // Âéü‰ª£Á†ÅÊòØ clearRectÔºåÂØπ‰∫éÂΩïÂà∂ËßÜÈ¢ëÊù•ËØ¥ÔºåÊàë‰ª¨ÈúÄË¶Å‰∏Ä‰∏™ÂÆûÂøÉÂ∫ïËâ≤„ÄÇ
                // ËøôÈáå‰ΩøÁî®‰∫Ü‰Ω† CSS ‰∏≠ÁöÑ body ËÉåÊôØËâ≤ #080808
                context.fillStyle = "#080808";
                context.fillRect(0, 0, width, height);
                // context.clearRect(0, 0, width, height); // Ê≥®ÈáäÊéâÂéüÊú¨ÁöÑ clearRect

                // ÁîªÂú∞ÁêÉËÉåÊôØ
                context.beginPath(); path({type: "Sphere"}); context.fillStyle = "#111"; context.fill();

                // ÁîªÈôÜÂú∞
                context.beginPath(); path(land); context.fillStyle = "#222"; context.fill();
                context.strokeStyle = "#000"; context.lineWidth = 0.5; context.stroke();

                // üåü 3. ÁîªËà™Á∫ø (‰øùÊåÅ‰∏çÂèò)
                routes.forEach(route => {
                    context.beginPath();
                    path(route);
                    context.strokeStyle = colorScale(route.distance);
                    context.globalAlpha = 0.3;
                    context.lineWidth = 0.6;
                    context.stroke();
                });
                context.globalAlpha = 1.0;

                // ÁîªÊú∫Âú∫ (‰øùÊåÅ‰∏çÂèò)
                data.airports.forEach(d => {
                    const p = projection(d.loc);
                    if (d3.geoDistance(d.loc, projection.invert([width/2, height/2])) > 1.57) return;

                    context.beginPath();
                    context.arc(p[0], p[1], rScale(d.degree), 0, 2 * Math.PI);

                    if (d.degree > 50) {
                        context.fillStyle = "rgba(255, 50, 50, 0.9)";
                    } else {
                        context.fillStyle = "#fff";
                    }
                    context.fill();
                });

                // ÁîªÂÖâÊôï (‰øùÊåÅ‰∏çÂèò)
                context.beginPath(); path({type: "Sphere"});
                context.strokeStyle = "rgba(255,255,255,0.1)"; context.lineWidth = 1.5; context.stroke();

                // [‰øÆÊîπÁÇπ 2] ÂΩïÂà∂Èí©Â≠ê
                if (isRecording) {
                    capturer.capture(canvas);
                }
            });
        });

        window.addEventListener('resize', () => {
             const dim = resize();
             width = dim.width; height = dim.height;
             projection.translate([width / 2, height / 2]).scale(height / 1.9);
        });

        // === ÊåâÈíÆÈÄªËæë ===
        document.getElementById('btnStart').addEventListener('click', () => {
            isRecording = true;
            capturer.start();
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnStop').style.display = 'block';
            document.getElementById('status').innerText = "Recording (wait for rotation)...";
            document.getElementById('status').style.color = "#bd34fe";
        });

        document.getElementById('btnStop').addEventListener('click', () => {
            isRecording = false;
            capturer.stop();
            capturer.save();
            document.getElementById('btnStart').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';
            document.getElementById('status').innerText = "Saved to Downloads";
            document.getElementById('status').style.color = "#aaa";
        });
    </script>
</body>
</html>
